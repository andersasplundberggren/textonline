<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtNgzE48LgUcvRNWwyeUh484h984yjz1jiqndoHZAkmcdQEngEjUcyPmRTVkhpq2w/exec';

    // Load category settings
    async function loadCategorySettings() {
        try {
            const response = await fetch(SCRIPT_URL + '?action=getSettings');
            const settings = await response.json();
            
            console.log('Loaded settings:', settings); // Debug
            
            const allowCustom = settings.allowCustomCategories === 'true' || settings.allowCustomCategories === true;
            const categories = settings.allowedCategories ? 
                settings.allowedCategories.split(',').map(c => c.trim()).filter(c => c) : [];
            
            const container = document.getElementById('categoryInputContainer');
            
            if (!allowCustom && categories.length > 0) {
                // Show dropdown with predefined categories
                container.innerHTML = `
                    <select
                        id="category"
                        class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                    >
                        <option value="">Välj en kategori...</option>
                        ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                `;
                document.getElementById('categoryHint').textContent = 'Välj en kategori från listan';
            } else if (!allowCustom && categories.length === 0) {
                // No categories defined by admin
                container.innerHTML = `
                    <input
                        type="text"
                        id="category"
                        placeholder="Inga kategorier tillgängliga - kontakta admin"
                        disabled
                        class="w-full p-4 border border-gray-300 rounded-lg bg-gray-100 text-lg cursor-not-allowed"
                    />
                `;
                document.getElementById('categoryHint').textContent = 'Admin har inte lagt till några kategorier ännu';
                document.getElementById('submitButton').disabled = true;
                document.getElementById('submitButton').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                // Show text input (custom categories allowed)
                container.innerHTML = `
                    <input
                        type="text"
                        id="category"
                        placeholder="T.ex. Feedback, Fråga, Idé, Förslag"
                        class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                    />
                `;
                document.getElementById('categoryHint').textContent = 'Skriv din egen kategori';
            }
            
        } catch (err) {
            console.error('Error loading category settings:', err);
            // Fallback to text input if settings can't be loaded
            const container = document.getElementById('categoryInputContainer');
            container.innerHTML = `
                <input
                    type="text"
                    id="category"
                    placeholder="T.ex. Feedback, Fråga, Idé, Förslag"
                    class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg"
                />
            `;
            document.getElementById('categoryHint').textContent = 'Skriv din egen kategori';
        }
    }

    // Rest of the script remains the same...
    function showMessage(type, message) {
        const successEl = document.getElementById('successMessage');
        const errorEl = document.getElementById('errorMessage');
        const loadingEl = document.getElementById('loadingMessage');
        
        successEl.classList.add('hidden');
        errorEl.classList.add('hidden');
        loadingEl.classList.add('hidden');

        if (type === 'success') {
            successEl.classList.remove('hidden');
        } else if (type === 'error') {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        } else if (type === 'loading') {
            loadingEl.classList.remove('hidden');
        }
    }

    function submitPost() {
        const categoryElement = document.getElementById('category');
        const content = document.getElementById('content').value;
        const submitButton = document.getElementById('submitButton');

        const category = categoryElement.value;

        if (!category.trim() || !content.trim()) {
            showMessage('error', 'Fyll i både kategori och innehåll');
            return;
        }

        const newPost = {
            id: Date.now(),
            category: category.trim(),
            content: content.trim(),
            timestamp: new Date().toISOString(),
            action: 'add'
        };

        showMessage('loading');
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = SCRIPT_URL;
        form.target = 'hidden_iframe';
        form.style.display = 'none';

        Object.keys(newPost).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = newPost[key];
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        setTimeout(() => {
            if (categoryElement.tagName === 'SELECT') {
                categoryElement.selectedIndex = 0;
            } else {
                categoryElement.value = '';
            }
            document.getElementById('content').value = '';
            
            showMessage('success');
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            
            setTimeout(() => {
                showMessage('');
            }, 5000);
        }, 2000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('content').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                submitPost();
            }
        });
    });

    loadCategorySettings();
</script>
